<!DOCTYPE html>

<html>
<head>
  <title>#</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="collection.html">
                collection.coffee
              </a>
            
              
              <a class="source" href="facets.html">
                facets.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="facetArray.html">
                facetArray.coffee
              </a>
            
              
              <a class="source" href="schema.html">
                schema.coffee
              </a>
            
              
              <a class="source" href="facet.html">
                facet.coffee
              </a>
            
              
              <a class="source" href="item.html">
                item.coffee
              </a>
            
              
              <a class="source" href="print.html">
                print.coffee
              </a>
            
              
              <a class="source" href="routes.html">
                routes.coffee
              </a>
            
              
              <a class="source" href="facet.html">
                facet.coffee
              </a>
            
              
              <a class="source" href="item.html">
                item.coffee
              </a>
            
              
              <a class="source" href="profile.html">
                profile.coffee
              </a>
            
              
              <a class="source" href="cube.html">
                cube.coffee
              </a>
            
              
              <a class="source" href="code.html">
                code.coffee
              </a>
            
              
              <a class="source" href="server.config.html">
                server.config.coffee
              </a>
            
              
              <a class="source" href="server.routes.html">
                server.routes.coffee
              </a>
            
              
              <a class="source" href="server.settings.html">
                server.settings.coffee
              </a>
            
              
              <a class="source" href="entityController.html">
                entityController.coffee
              </a>
            
              
              <a class="source" href="extensionController.html">
                extensionController.coffee
              </a>
            
              
              <a class="source" href="facetManager.html">
                facetManager.coffee
              </a>
            
              
              <a class="source" href="itemController.html">
                itemController.coffee
              </a>
            
              
              <a class="source" href="printController.html">
                printController.coffee
              </a>
            
              
              <a class="source" href="schema.html">
                schema.coffee
              </a>
            
              
              <a class="source" href="solrManager.html">
                solrManager.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>#</h1>
<p>ExtensionController.coffee</p>
<p>@author: Emanuel Lauria <a href="&#109;&#x61;&#x69;&#108;&#x74;&#x6f;&#58;&#x65;&#x6d;&#97;&#110;&#117;&#x65;&#108;&#46;&#x6c;&#97;&#x75;&#114;&#x69;&#97;&#x40;&#x7a;&#x61;&#108;&#97;&#110;&#100;&#x6f;&#x2e;&#x64;&#101;">&#x65;&#x6d;&#97;&#110;&#117;&#x65;&#108;&#46;&#x6c;&#97;&#x75;&#114;&#x69;&#97;&#x40;&#x7a;&#x61;&#108;&#97;&#110;&#100;&#x6f;&#x2e;&#x64;&#101;</a></p>
<p>Note: This file is currently unmantained. Entity creation feature is on hold.</p>
<h1>#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs = require <span class="string">'fs'</span>
_ = require <span class="string">'underscore'</span>
mime = require <span class="string">'mime-magic'</span>
http    = require <span class="string">"http"</span>
async   = require <span class="string">"async"</span>
exec    = require(<span class="string">"child_process"</span>).exec

SolrManager = require <span class="string">'./solrManager.coffee'</span>
ItemController = require <span class="string">'./itemController.coffee'</span>

settings = require <span class="string">"<span class="subst">#{__dirname}</span>/../server.settings.coffee"</span>
entities = require <span class="string">"<span class="subst">#{__dirname}</span>/../entities.json"</span>

e = process.env.NODE_ENV
defaultDatabase = settings.Default.Database.development
defaultDatabase = settings.Default.Database.production <span class="keyword">if</span> e <span class="keyword">is</span> <span class="string">"production"</span>
defaultAppSettings = settings.Default.Application

<span class="class"><span class="keyword">class</span> <span class="title">ExtensionController</span></span>
    module.exports = ExtensionController

    constructor: (app) -&gt;
        app.post    <span class="string">'/entity/:name'</span>,     (a...)  =&gt; <span class="property">@create</span>  a...
        app.<span class="keyword">delete</span>  <span class="string">'/entity/:name'</span>,     (a...)  =&gt; <span class="property">@delete</span>  a...

    create: (req, res) =&gt;
        name = req.files.<span class="reserved">import</span>.name.split(<span class="string">'.'</span>)[<span class="number">0</span>]
        type = req.files.<span class="reserved">import</span>.name.split(<span class="string">'.'</span>)[<span class="number">1</span>]
        file = req.files.<span class="reserved">import</span>.path
        r = {}

        async.series
            getMime: (cb) =&gt;
                mime file, (err, t) -&gt;
                    r.type = t
                    cb()

            readFile: (cb) =&gt;
                fs.readFile file, <span class="string">'utf8'</span>, (err, d) -&gt;
                    r.data = d
                    cb(err)

            touchDirs: (cb) =&gt;
                <span class="property">@touchExtensionDir</span> name, (err) -&gt;
                    cb(err)

            createCore: (cb) =&gt;
                <span class="keyword">return</span> cb() <span class="keyword">unless</span> entities.indexOf(name) <span class="keyword">is</span> -<span class="number">1</span>
                <span class="property">@createCore</span> name, (err) -&gt;
                    cb(err)

            generateSchema: (cb) =&gt;
                <span class="keyword">if</span> entities.indexOf(name) <span class="keyword">isnt</span> -<span class="number">1</span>
                    fs.readFile <span class="string">"./entities/<span class="subst">#{name}</span>/schema.json"</span>, <span class="string">"utf8"</span>,
                        (err, s) -&gt;
                            <span class="keyword">throw</span> err <span class="keyword">if</span> err
                            r.schema = s
                            <span class="keyword">return</span> cb()
                <span class="keyword">else</span>
                    <span class="keyword">if</span> type <span class="keyword">is</span> <span class="string">"csv"</span>
                        ids = r.data.split(<span class="string">'\n'</span>)[<span class="number">0</span>].split(<span class="string">';'</span>)
                    <span class="keyword">else</span>
                        ids = []
                        _.each JSON.parse(r.data), (item) -&gt;
                            _.each item, (value, key) -&gt;
                                ids.push key <span class="keyword">if</span> ids.indexOf(key) <span class="keyword">is</span> -<span class="number">1</span>
                    <span class="property">@generateSchema</span> name, ids, (s) -&gt;
                        r.schema = s
                        cb()

            importData: (cb) =&gt;
                <span class="keyword">if</span> type <span class="keyword">is</span> <span class="string">'csv'</span>
                    <span class="keyword">return</span> <span class="property">@importFromCSV</span> r.schema, name, r.data, (err) -&gt;
                        cb(err)
                <span class="keyword">return</span> <span class="property">@importFromJson</span> r.schema, name, r.data, (err) -&gt;
                    cb(err)

            saveFile: (cb) =&gt;
                <span class="keyword">return</span> cb() <span class="keyword">unless</span> entities.indexOf(name) <span class="keyword">is</span> -<span class="number">1</span>
                entities.push name
                <span class="property">@saveJsonToFile</span> entities, settings.EntitiesFile, (err) -&gt;
                    cb(err)

            setResponse: (cb) =&gt;
                fs.stat file, (err, stats) -&gt;
                    res.setHeader <span class="string">'Content-Type'</span>,
                        <span class="string">'text/plain; charset=utf8'</span>
                    r.response = [
                        <span class="string">"name"</span>: name + <span class="string">'.csv'</span>
                        <span class="string">"size"</span>: stats.size
                        <span class="string">"type"</span>: r.type
                    ]
                    cb(err)

            removeTmpFile: (cb) -&gt;
                fs.unlink file, (err) -&gt;
                    cb(err)
        ,
            (result) -&gt;
                res.send r.response

    <span class="keyword">delete</span>: (req, res) =&gt;
        name = req.params.name
        child = exec <span class="string">"rm -rf entities/<span class="subst">#{name}</span> public/images/<span class="subst">#{name}</span>"</span>,
            (err) =&gt;
                <span class="keyword">throw</span> err <span class="keyword">if</span> err
                es = []
                _.each entities, (e) =&gt;
                    <span class="keyword">return</span> <span class="keyword">if</span> e <span class="keyword">is</span> name
                    es.push e
                entities = es
                <span class="property">@saveJsonToFile</span> entities, settings.EntitiesFile, () =&gt;
                    <span class="property">@removeCore</span> name, () -&gt;
                        res.send <span class="string">'Extension successfully removed'</span>

    failedCreatingExtension: (name, err) =&gt;
        console.log <span class="string">'Failed creating entity: '</span>, name
        <span class="property">@delete</span> () -&gt;
            <span class="keyword">throw</span> err

    generateSchema: (name, ids, cb) =&gt;
        schema = []
        _.each ids, (id) =&gt;
            <span class="keyword">return</span> <span class="keyword">if</span> id <span class="keyword">is</span> <span class="string">'id'</span>
            schema.push <span class="property">@createSchemaField</span> id, <span class="string">'string'</span>
        path = <span class="string">"<span class="subst">#{__dirname}</span>/../entities/<span class="subst">#{name}</span>/schema.json"</span>
        <span class="property">@saveJsonToFile</span> schema, path, () -&gt;
            cb schema

    touchExtensionDir: (name, cb) =&gt;
        <span class="keyword">return</span> cb() <span class="keyword">if</span> entities.indexOf(name) <span class="keyword">isnt</span> -<span class="number">1</span>
        archivePath = <span class="string">"<span class="subst">#{__dirname}</span>/../public/images/<span class="subst">#{name}</span>/archive/"</span>
        child = exec <span class="string">"mkdir -p <span class="subst">#{archivePath}</span>"</span>, (err) =&gt;
            <span class="keyword">throw</span> err <span class="keyword">if</span> err
        extPath = <span class="string">"<span class="subst">#{__dirname}</span>/../entities/<span class="subst">#{name}</span>"</span>
        child = exec <span class="string">"mkdir -p <span class="subst">#{extPath}</span>"</span>, (err) =&gt;
            <span class="keyword">throw</span> err <span class="keyword">if</span> err
            _.each [ <span class="string">'code.coffee'</span>, <span class="string">'style.styl'</span>, <span class="string">'templates.jade'</span> ], (file) =&gt;
                child = exec <span class="string">"touch entities/<span class="subst">#{name}</span>/<span class="subst">#{file}</span>"</span>, (err) =&gt;
                    failedCreatingExtension name, err <span class="keyword">if</span> err
            <span class="property">@touchDBSettingsFile</span>(name)
            <span class="property">@touchAppSettingsFile</span>(name)
            cb(err) <span class="keyword">if</span> cb

    importFromJson: (schema, name, jsonarr, cb) =&gt;
        jsonarr = JSON.parse jsonarr
        async.forEach jsonarr, (e, _cb) =&gt;
            e = removeSuffix e
            id = <span class="property">@generateId</span>()

            solrManager = <span class="keyword">new</span> SolrManager name
            solrManager.createSolrClient name

            newItem = _.extend {id: id}, solrManager.addObjSuffix name, e

            solrManager.client.add [newItem], (err, result) -&gt;
                <span class="keyword">throw</span> err <span class="keyword">if</span> err
                _cb()
        ,
            (err) -&gt;
                <span class="keyword">throw</span> err <span class="keyword">if</span> err
                cb() <span class="keyword">if</span> cb

    importFromCSV: (schema, name, csv, cb) =&gt;
        lines = csv.split(<span class="string">'\n'</span>)
        ids = lines[<span class="number">0</span>].split(<span class="string">';'</span>)
        async.forEach lines.slice(<span class="number">1</span>),
            (l, _cb) =&gt;
                <span class="keyword">return</span> _cb() <span class="keyword">unless</span> l
                item = {}
                _.each l.split(<span class="string">';'</span>), (v, i) =&gt;
                    <span class="keyword">return</span> _cb() <span class="keyword">unless</span> v
                    item[ids[i].split(<span class="string">'-'</span>)[<span class="number">0</span>]] = v
                    field = <span class="property">@getFieldFromSchema</span> name, ids[i].split(<span class="string">'-'</span>)[<span class="number">0</span>]
                    <span class="keyword">if</span> field.multivalue
                        item[ids[i].split(<span class="string">'-'</span>)[<span class="number">0</span>]] = v.split(<span class="string">','</span>)

                id = <span class="property">@generateId</span>()

                solrManager = <span class="keyword">new</span> SolrManager name
                solrManager.createClient()

                item = solrManager.addObjSuffix(name, item)
                newItem = _.extend {id: id}, item

                solrManager.client.add [newItem], (err, result) -&gt;
                    <span class="keyword">throw</span> err <span class="keyword">if</span> err
                    _cb()
        ,
            (err) -&gt;
                <span class="keyword">throw</span> err <span class="keyword">if</span> err
                cb() <span class="keyword">if</span> cb

    createCore: (name, cb) =&gt;
        solrPath = defaultDatabase.path
        dataRoot = defaultDatabase.dataRoot
        dataDir = <span class="string">"/data/zalando/app/<span class="subst">#{dataRoot}</span>/solr/data/<span class="subst">#{name}</span>/"</span>
        path = <span class="string">"<span class="subst">#{solrPath}</span>/admin/cores?action=CREATE"</span>
        path += <span class="string">"&amp;name=<span class="subst">#{name}</span>"</span>
        path += <span class="string">"&amp;instanceDir=conf/cube"</span>
        path += <span class="string">"&amp;dataDir=<span class="subst">#{dataDir}</span>"</span>
        db = _.extend {}, defaultDatabase
        db.path = path

        req = http.request db, (res) =&gt;
            res.setEncoding <span class="string">'utf8'</span>
            res.<span class="literal">on</span> <span class="string">'data'</span>, (chunk) =&gt;
                cb() <span class="keyword">if</span> cb

        req.<span class="literal">on</span> <span class="string">'error'</span>, (e) =&gt;
            console.log <span class="string">'Failed creating core with error:'</span>, e.message

        req.write <span class="string">'data\n'</span>
        req.write <span class="string">'data\n'</span>
        req.end()

    removeCore: (name, cb) -&gt;
        solrPath = defaultDatabase.path
        path = <span class="string">"<span class="subst">#{solrPath}</span>/admin/cores?action=UNLOAD"</span>
        path += <span class="string">"&amp;core=<span class="subst">#{name}</span>"</span>
        path += <span class="string">"&amp;deleteIndex=true"</span>
        db = _.extend {}, defaultDatabase
        db.path = path

        req = http.request db, (res) -&gt;
            res.setEncoding <span class="string">'utf8'</span>
            res.<span class="literal">on</span> <span class="string">'data'</span>, (chunk) -&gt;
                cb() <span class="keyword">if</span> cb

        req.<span class="literal">on</span> <span class="string">'error'</span>, (e) -&gt;
            console.log <span class="string">'Failed removing core with error:'</span>, e.message

        req.write <span class="string">'data\n'</span>
        req.write <span class="string">'data\n'</span>
        req.end()

    saveJsonToFile: (obj, path, cb) =&gt;
        fs.writeFile path, JSON.stringify(obj, <span class="literal">null</span>, <span class="number">4</span>), (err) -&gt;
            console.log <span class="string">'Error writing file'</span> <span class="keyword">if</span> err
            <span class="keyword">throw</span> err <span class="keyword">if</span> err
            cb() <span class="keyword">if</span> cb

    touchDBSettingsFile: (name, cb) =&gt;
        <span class="keyword">return</span> cb() <span class="keyword">if</span> entities.indexOf(name) <span class="keyword">isnt</span> -<span class="number">1</span>
        db = _.extend {}, defaultDatabase
        db.core = name
        <span class="property">@saveJsonToFile</span> db, <span class="string">"entities/<span class="subst">#{name}</span>/db.json"</span>, cb

    touchAppSettingsFile: (name, cb) =&gt;
        <span class="keyword">return</span> cb() <span class="keyword">if</span> entities.indexOf(name) <span class="keyword">isnt</span> -<span class="number">1</span>
        appSettings = _.extend {}, defaultAppSettings
        appSettings.entity = name
        appSettings.title = name
        <span class="property">@saveJsonToFile</span> appSettings, <span class="string">"entities/<span class="subst">#{name}</span>/settings.json"</span>, cb

    createSchemaField: (id, type) =&gt;
        suffix = id.split(<span class="string">'-'</span>)[<span class="number">1</span>]
        id = id.split(<span class="string">'-'</span>)[<span class="number">0</span>]
        field = _.extend {}, settings.Default.SchemaField
        field.id = id
        field.label = id

        <span class="keyword">return</span> field <span class="keyword">unless</span> suffix
        field.type = settings.Default.Suffix[suffix]
        field

    getFieldFromSchema: (name, id) =&gt;
        schema = require <span class="string">"<span class="subst">#{__dirname}</span>/../entities/<span class="subst">#{name}</span>/schema.json"</span>
        field = {}
        _.each schema, (o) =&gt;
            <span class="keyword">if</span> o.id <span class="keyword">is</span> id
                field = o
        field

    generateId: () -&gt;
        chars = <span class="string">"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span>
        today = <span class="keyword">new</span> Date()
        result = today.valueOf().toString <span class="number">16</span>
        result += chars.substr Math.floor(Math.random() * chars.length), <span class="number">1</span>
        result += chars.substr Math.floor(Math.random() * chars.length), <span class="number">1</span>
        result</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
